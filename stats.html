<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stats ‚Äì PageBud</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css?v=2025-08-28-2">
  <style>
    .seg {
      display: flex;
      gap: 8px
    }

    .seg .time-btn {
      padding: 6px 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--background);
      cursor: pointer
    }

    .seg .time-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary)
    }

    .cal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px
    }

    .cal-nav {
      display: flex;
      gap: 6px
    }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px
    }

    .cal-day {
      min-height: 82px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px;
      position: relative
    }

    .cal-day .num {
      font-weight: 700;
      font-size: 12px;
      color: var(--text-light)
    }

    .cal-day.today {
      outline: 2px solid var(--primary)
    }

    .cal-week {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px
    }

    .cal-week .cal-day {
      min-height: 100px
    }

    .cal-year {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px
    }

    .mini-month {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px
    }

    .mini-month .label {
      font-weight: 700;
      margin-bottom: 6px
    }

    .mini-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px
    }

    .mini-cell {
      height: 12px;
      background: var(--background);
      border-radius: 2px
    }

    .mini-cell.has {
      background: var(--primary)
    }

    .dotbar {
      position: absolute;
      right: 6px;
      bottom: 6px;
      display: flex;
      gap: 4px
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%
    }

    .dot.start {
      background: #4CAF50
    }

    .dot.finish {
      background: #f44336
    }
  </style>
</head>

<body>
  <div class="app-container">
    <div class="stats-header">
      <div class="back-button" onclick="location.href='index.html'"><i class="fas fa-arrow-left"></i></div>
      <h1>Stats</h1>
      <div style="width:32px"></div>
    </div>

    <div class="content-wrapper">
      <!-- Overview -->
      <div class="stats-section">
        <div class="section-header">
          <div class="section-title"><i class="fas fa-chart-pie"></i><span>Overview</span></div>
        </div>
        <div class="overview-grid">
          <div class="stat-card">
            <div class="stat-number" id="totBooks">0</div>
            <div class="stat-label">Total Books</div>
          </div>
          <div class="stat-card rating-stat">
            <div class="stat-number" id="avgRating">0.00</div>
            <div class="stat-label">Avg Rating</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totFinished">0</div>
            <div class="stat-label">Finished</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totReading">0</div>
            <div class="stat-label">Reading</div>
          </div>
        </div>
      </div>

      <!-- Calendar -->
      <div class="stats-section">
        <div class="section-header">
          <div class="section-title"><i class="fas fa-calendar"></i><span>Reading Calendar</span></div>
          <div class="seg">
            <button class="time-btn active" id="btnDaily">Daily</button>
            <button class="time-btn" id="btnWeekly">Weekly</button>
            <button class="time-btn" id="btnMonthly">Monthly</button>
            <button class="time-btn" id="btnYearly">Yearly</button>
          </div>
        </div>

        <div class="cal-head">
          <div id="calLabel" style="font-weight:700"></div>
          <div class="cal-nav">
            <button class="btn" id="calPrev">‚óÄ</button>
            <button class="btn" id="calNext">‚ñ∂</button>
          </div>
        </div>
        <div id="calWrap"></div>
      </div>

      <!-- Top Authors / Genres / Moods -->
      <div class="stats-section">
        <div class="section-header">
          <div class="section-title"><i class="fas fa-user-edit"></i><span>Top Authors</span></div>
        </div>
        <div class="authors-list" id="authorsList"></div>
      </div>
      <div class="stats-section">
        <div class="section-header">
          <div class="section-title"><i class="fas fa-tags"></i><span>Top Genres</span></div>
        </div>
        <div class="authors-list" id="genresList"></div>
      </div>
      <div class="stats-section">
        <div class="section-header">
          <div class="section-title"><i class="fas fa-face-smile"></i><span>Top Moods</span></div>
        </div>
        <div class="authors-list" id="moodsList"></div>
      </div>

      <!-- Streak -->
      <div class="stats-section">
        <div class="section-header">
          <div class="section-title"><i class="fas fa-fire"></i><span>Reading Streak</span></div>
        </div>
        <div class="streak-container">
          <div class="streak-number" id="streakNum">0</div>
          <div class="streak-label">Day streak</div>
          <div class="streak-calendar" id="streakCal"></div>
        </div>
      </div>
    </div>

    <nav class="bottom-nav">
      <div class="nav-item" onclick="location.href='index.html'"><i class="fas fa-book"></i> Library</div>
      <div class="nav-item active"><i class="fas fa-chart-line"></i> Stats</div>
      <div class="nav-item" onclick="location.href='buddy-read.html'"><i class="fas fa-users"></i> Buddy Read</div>
      <div class="nav-item" onclick="location.href='settings.html'"><i class="fas fa-cog"></i> Settings</div>
    </nav>
  </div>

  <script src="firebase.js"></script>
  <script src="script.js?v=2025-08-28-2"></script>
  <script>
    // --- helpers from script.js are available (loadBooks, getStreakData, etc.) ---

    const calWrap = document.getElementById('calWrap');
    const calLabel = document.getElementById('calLabel');
    const btns = {
      daily: document.getElementById('btnDaily'),
      weekly: document.getElementById('btnWeekly'),
      monthly: document.getElementById('btnMonthly'),
      yearly: document.getElementById('btnYearly')
    };
    let mode = 'daily';
    let view = new Date();

    function setActive(m) {
      Object.values(btns).forEach(b => b.classList.remove('active'));
      btns[m].classList.add('active');
      mode = m; render();
    }

    function mapEvents() {
      const ev = {};
      const add = (iso, t, b) => {
        if (!iso) return;
        const d = iso.slice(0, 10);
        (ev[d] ??= []).push({ t, book: b });
      };
      loadBooks().forEach(b => {
        add(b.startedAt, 'start', b); add(b.finishedAt, 'finish', b);
      });
      return ev;
    }

    function renderDaily() {
      const d = view; const dStr = d.toISOString().slice(0, 10);
      calLabel.textContent = d.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      const ev = mapEvents()[dStr] || [];
      calWrap.innerHTML = `<div class="cal-grid" style="grid-template-columns:1fr"><div class="cal-day today">
        <div class="num">${d.toLocaleDateString()}</div>
        <div style="margin-top:8px">${ev.length ? ev.map(e => `${e.t === 'start' ? 'üìó' : 'üèÅ'} ${e.book.title || 'Untitled'}`).join('<br>') : '<span class="muted">No events</span>'}</div>
      </div></div>`;
    }

    function renderWeekly() {
      // Start Monday
      const temp = new Date(view); const day = (temp.getDay() + 6) % 7;
      temp.setDate(temp.getDate() - day);
      const start = new Date(temp);
      const end = new Date(temp); end.setDate(end.getDate() + 6);
      calLabel.textContent = `${start.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })} ‚Äì ${end.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })}`;
      const ev = mapEvents();
      let html = `<div class="cal-week">`;
      for (let i = 0; i < 7; i++) {
        const d = new Date(start); d.setDate(start.getDate() + i);
        const dStr = d.toISOString().slice(0, 10);
        const today = (new Date().toDateString() === d.toDateString());
        const list = (ev[dStr] || []);
        html += `<div class="cal-day ${today ? 'today' : ''}"><div class="num">${d.toLocaleDateString(undefined, { weekday: 'short' })} ${d.getDate()}</div>
          <div class="dotbar">
            ${list.some(x => x.t === 'start') ? '<span class="dot start"></span>' : ''}
            ${list.some(x => x.t === 'finish') ? '<span class="dot finish"></span>' : ''}
          </div>
          <div style="margin-top:6px;font-size:12px">${list.map(e => `${e.t === 'start' ? 'üìó' : 'üèÅ'} ${e.book.title || 'Untitled'}`).join('<br>')}</div>
        </div>`;
      }
      html += `</div>`;
      calWrap.innerHTML = html;
    }

    function renderMonthly() {
      const y = view.getFullYear(), m = view.getMonth();
      calLabel.textContent = new Date(y, m, 1).toLocaleString(undefined, { month: 'long', year: 'numeric' });
      const first = new Date(y, m, 1);
      const startDay = (first.getDay() + 6) % 7;
      const daysInMonth = new Date(y, m + 1, 0).getDate();
      const totalCells = Math.ceil((startDay + daysInMonth) / 7) * 7;
      const ev = mapEvents();
      let html = `<div class="cal-grid">`;
      for (let i = 0; i < totalCells; i++) {
        const dayNum = i - startDay + 1;
        const inMonth = dayNum >= 1 && dayNum <= daysInMonth;
        const d = new Date(y, m, dayNum);
        const dStr = d.toISOString().slice(0, 10);
        const list = inMonth ? (ev[dStr] || []) : [];
        const today = (new Date().toDateString() === d.toDateString());
        html += `<div class="cal-day ${today ? 'today' : ''}" style="${inMonth ? '' : 'opacity:.35'}">
          <div class="num">${inMonth ? dayNum : ''}</div>
          ${inMonth ? `<div class="dotbar">
            ${list.some(x => x.t === 'start') ? '<span class="dot start"></span>' : ''}
            ${list.some(x => x.t === 'finish') ? '<span class="dot finish"></span>' : ''}
          </div>`: ''}
        </div>`;
      }
      html += `</div>`;
      calWrap.innerHTML = html;
    }

    function renderYearly() {
      const y = view.getFullYear(); calLabel.textContent = y;
      const ev = mapEvents();
      let html = `<div class="cal-year">`;
      for (let m = 0; m < 12; m++) {
        const first = new Date(y, m, 1);
        const startDay = (first.getDay() + 6) % 7;
        const dim = new Date(y, m + 1, 0).getDate();
        const total = Math.ceil((startDay + dim) / 7) * 7;
        html += `<div class="mini-month"><div class="label">${first.toLocaleString(undefined, { month: 'short' })}</div>
        <div class="mini-grid">`;
        for (let i = 0; i < total; i++) {
          const dnum = i - startDay + 1;
          const inM = dnum >= 1 && dnum <= dim;
          let has = false;
          if (inM) {
            const d = new Date(y, m, dnum);
            const dStr = d.toISOString().slice(0, 10);
            has = (ev[dStr] || []).length > 0;
          }
          html += `<div class="mini-cell ${has ? 'has' : ''}" style="${inM ? '' : 'opacity:.2'}"></div>`;
        }
        html += `</div></div>`;
      }
      html += `</div>`;
      calWrap.innerHTML = html;
    }

    function render() {
      // overview tall
      const books = loadBooks();
      const finished = books.filter(b => b.status === 'finished');
      const reading = books.filter(b => b.status === 'reading');
      document.getElementById('totBooks').textContent = books.length.toLocaleString();
      document.getElementById('totFinished').textContent = finished.length.toLocaleString();
      document.getElementById('totReading').textContent = reading.length.toLocaleString();
      const avg = finished.length ? (finished.reduce((a, b) => a + (Number(b.rating) || 0), 0) / finished.length) : 0;
      document.getElementById('avgRating').textContent = avg.toFixed(2);

      // top authors/genres/moods
      function topCount(arr, getter) {
        const m = {}; arr.forEach(b => {
          const v = getter(b); if (!v) return;
          (Array.isArray(v) ? v : [v]).forEach(x => {
            const k = (x || '').trim(); if (!k) return; m[k] = (m[k] || 0) + 1;
          });
        });
        return Object.entries(m).sort((a, b) => b[1] - a[1]).slice(0, 6);
      }
      function renderBars(el, list) {
        if (!el) return; const max = Math.max(1, ...list.map(x => x[1]));
        el.innerHTML = list.map(([name, count]) => `
          <div class="author-item">
            <div class="author-name">${name}</div>
            <div class="author-bar"><div class="author-fill" style="width:${(count / max) * 100}%"></div></div>
            <div class="author-count">${count}</div>
          </div>`).join('') || `<div class="muted">No data</div>`;
      }
      renderBars(document.getElementById('authorsList'), topCount(books, b => b.author || "Unknown"));
      renderBars(document.getElementById('genresList'), topCount(books, b => b.genres || []));
      renderBars(document.getElementById('moodsList'), topCount(books, b => b.moods || []));

      // streak mini-grid
      const st = getStreakData(); document.getElementById('streakNum').textContent = st.current || 0;
      const cal = document.getElementById('streakCal'); cal.innerHTML = '';
      for (let i = 27; i >= 0; i--) {
        const cell = document.createElement('div');
        cell.className = 'streak-day ' + (i < st.current ? 'active' : 'inactive'); cal.appendChild(cell);
      }

      // calendar modes
      if (mode === 'daily') renderDaily();
      if (mode === 'weekly') renderWeekly();
      if (mode === 'monthly') renderMonthly();
      if (mode === 'yearly') renderYearly();
    }

    btns.daily.onclick = () => setActive('daily');
    btns.weekly.onclick = () => setActive('weekly');
    btns.monthly.onclick = () => setActive('monthly');
    btns.yearly.onclick = () => setActive('yearly');

    document.getElementById('calPrev').onclick = () => {
      if (mode === 'daily') view.setDate(view.getDate() - 1);
      if (mode === 'weekly') view.setDate(view.getDate() - 7);
      if (mode === 'monthly') view.setMonth(view.getMonth() - 1);
      if (mode === 'yearly') view.setFullYear(view.getFullYear() - 1);
      render();
    };
    document.getElementById('calNext').onclick = () => {
      if (mode === 'daily') view.setDate(view.getDate() + 1);
      if (mode === 'weekly') view.setDate(view.getDate() + 7);
      if (mode === 'monthly') view.setMonth(view.getMonth() + 1);
      if (mode === 'yearly') view.setFullYear(view.getFullYear() + 1);
      render();
    };

    requireAuth(() => render());
  </script>
</body>

</html>